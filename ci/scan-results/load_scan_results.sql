TRUNCATE TABLE CONSOLIDATED_SCAN_RESULT;

LOAD DATA LOCAL INFILE '%CSVFILE%'
    INTO TABLE CONSOLIDATED_SCAN_RESULT
    FIELDS
    TERMINATED BY ','
    OPTIONALLY ENCLOSED BY '"'
    LINES
    TERMINATED BY '\n'
    (@commit, @branch, @release, @scantime, @jobnum, @scanner, @vulnid, @sev, @target)
    SET
        VERRAZZANO_COMMIT_HASH = @commit,
        BRANCH_NAME = @branch,
        RELEASE_TAG = @release,
        SCAN_TIME = STR_TO_DATE(@scantime, '%Y%m%d%H%i%s'),
        JOB_NUMBER = @jobnum,
        SCANNER_NAME = @scanner,
        VULNERABILITY_ID = @vulnid,
        SEVERITY = @sev,
        SCAN_TARGET = @target;

INSERT INTO SCAN_JOB(JOB_NUMBER, JOB_NAME, BRANCH_NAME)
SELECT DISTINCT JOB_NUMBER, "Verrazzano Daily Scans", BRANCH_NAME FROM CONSOLIDATED_SCAN_RESULT;

INSERT INTO SCAN_RESULT(
    VERRAZZANO_COMMIT_HASH, RELEASE_TAG, SCAN_TIME, TRIAGE_TASK_ID, SCANNER_NAME, SEVERITY, SCAN_TARGET, SCAN_TARGET_COMMIT_HASH)
SELECT
    VERRAZZANO_COMMIT_HASH, RELEASE_TAG, SCAN_TIME, null, SCANNER_NAME, SEVERITY, SCAN_TARGET, 'TBD-Scan-target-commit'
FROM CONSOLIDATED_SCAN_RESULT;

-- insert rows into TRIAGE_TASK for vulnerability/release/target combinations
-- that don't already exist in TRIAGE_TASK
INSERT INTO TRIAGE_TASK(
    VULNERABILITY_ID, VULNERABILITY_TARGET, RELEASE_TAG, URL, TRIAGE_STATUS)
SELECT DISTINCT VULNERABILITY_ID, SCAN_TARGET, RELEASE_TAG, 'TBD-URL', 'NEEDS_TRIAGE'
FROM CONSOLIDATED_SCAN_RESULT csr
WHERE NOT EXISTS (
  SELECT * from TRIAGE_TASK WHERE
    VULNERABILITY_ID = csr.VULNERABILITY_ID AND
    VULNERABILITY_TARGET = csr.SCAN_TARGET AND
    RELEASE_TAG = csr.RELEASE_TAG);

COMMIT;